/*** DTB_USER_CODE_START vvv Add file header below vvv ***/
/*** DTB_USER_CODE_END   ^^^ Add file header above ^^^ ***/

/*
 * File: audio_control_stubs.c
 * Contains: Module callbacks and connection functions
 *
 * This file was generated by dtcodegen, from module audio_control
 *
 * Any text may be added between the DTB_USER_CODE_START and
 * DTB_USER_CODE_END comments (even non-C code). Descriptive comments
 * are provided only as an aid.
 *
 *  ** EDIT ONLY WITHIN SECTIONS MARKED WITH DTB_USER_CODE COMMENTS.  **
 *  ** ALL OTHER MODIFICATIONS WILL BE OVERWRITTEN. DO NOT MODIFY OR  **
 *  ** DELETE THE GENERATED COMMENTS!                                 **
 */

#include <stdio.h>
#include <Xm/Xm.h>
#include "dtb_utils.h"
#include "sdtactrl.h"
#include "audio_control_ui.h"


/**************************************************************************
 *** DTB_USER_CODE_START
 ***
 *** All necessary header files have been included.
 ***
 *** Add include files, types, macros, externs, and user functions here.
 ***/
#include "audio_util.h"
static Widget PlayVolScale;
static Widget PlayBalScale;
static Widget RecordVolScale;
static Widget RecordBalScale;

/*** DTB_USER_CODE_END
 ***
 *** End of user code section
 ***
 **************************************************************************/



void 
SysRecVolChangeCB(
    Widget widget,
    XtPointer clientData,
    XtPointer callData
)
{
    /*** DTB_USER_CODE_START vvv Add C variables and code below vvv ***/
    XmScaleCallbackStruct *cbs = (XmScaleCallbackStruct*)callData;
    int lo, hi;

    XtVaGetValues (widget, XmNminimum, &lo,
			   XmNmaximum, &hi, NULL);
    if (cbs->reason == XmCR_VALUE_CHANGED)
      ChangeRecordVolume(cbs->value, lo, hi);
    else
      ChangeDragRecordVolume(cbs->value, lo, hi);
    /*** DTB_USER_CODE_END   ^^^ Add C variables and code above ^^^ ***/
    
    /*** DTB_USER_CODE_START vvv Add C code below vvv ***/
    /*** DTB_USER_CODE_END   ^^^ Add C code above ^^^ ***/
}


void 
SysPlayVolChangeCB(
    Widget widget,
    XtPointer clientData,
    XtPointer callData
)
{
    /*** DTB_USER_CODE_START vvv Add C variables and code below vvv ***/
    XmScaleCallbackStruct *cbs = (XmScaleCallbackStruct*)callData;
    int	  lo, hi;

    XtVaGetValues (widget, XmNminimum, &lo,
			   XmNmaximum, &hi, NULL);
    if (cbs->reason == XmCR_VALUE_CHANGED)
      ChangePlayVolume(cbs->value, lo, hi);
    else
      ChangeDragPlayVolume(cbs->value, lo, hi);

    /*** DTB_USER_CODE_END   ^^^ Add C variables and code above ^^^ ***/
    
    /*** DTB_USER_CODE_START vvv Add C code below vvv ***/
    /*** DTB_USER_CODE_END   ^^^ Add C code above ^^^ ***/
}

void 
SysMuteCB(
    Widget widget,
    XtPointer clientData,
    XtPointer callData
)
{
    /*** DTB_USER_CODE_START vvv Add C variables and code below vvv ***/
    XmToggleButtonCallbackStruct *cbs = (XmToggleButtonCallbackStruct*)callData;
    Boolean set;
    if (widget == dtb_audio_control_main_window.mute_rb_items.On_item) {
      XtVaGetValues (widget, XmNset, &set, NULL);
      if (set == True)
        ChangeMuteOutput(SATrue);  /* Mute is on */
    }
    else if (widget == dtb_audio_control_main_window.mute_rb_items.Off_item) {
      XtVaGetValues (widget, XmNset, &set, NULL);
      if (set == True)
        ChangeMuteOutput(SAFalse); /* Mute is off */
    }

    /*** DTB_USER_CODE_END   ^^^ Add C variables and code above ^^^ ***/
    
    /*** DTB_USER_CODE_START vvv Add C code below vvv ***/
    /*** DTB_USER_CODE_END   ^^^ Add C code above ^^^ ***/
}


void 
SysOutputPortCB(
    Widget widget,
    XtPointer clientData,
    XtPointer callData
)
{
    /*** DTB_USER_CODE_START vvv Add C variables and code below vvv ***/
    XmToggleButtonCallbackStruct *cbs = (XmToggleButtonCallbackStruct*)callData;
    Boolean set;
    if (widget == dtb_audio_control_main_window.speaker_cbs_items.Speaker_item) {
      XtVaGetValues (widget, XmNset, &set, NULL);
      if (set == True)
        ChangeSpeakerOutputPort(SATrue);  /* Speaker on */
      else
        ChangeSpeakerOutputPort(SAFalse);  /* Speaker off */
    }
    else if (widget == dtb_audio_control_main_window.speaker_cbs_items.Headphone_item) {
      XtVaGetValues (widget, XmNset, &set, NULL);
      if (set == True)
        ChangeHeadphoneOutputPort(SATrue); /* Headphone on */
      else
        ChangeHeadphoneOutputPort(SAFalse); /* Headphone on */
    }
    else if (widget == dtb_audio_control_main_window.speaker_cbs_items.Line_Out_item) {
      XtVaGetValues (widget, XmNset, &set, NULL);
      if (set == True)
        ChangeLineOutOutputPort(SATrue); /* Line Out on */
      else
        ChangeLineOutOutputPort(SAFalse); /* Line Out off */
    }

    /*** DTB_USER_CODE_END   ^^^ Add C variables and code above ^^^ ***/
    
    /*** DTB_USER_CODE_START vvv Add C code below vvv ***/
    /*** DTB_USER_CODE_END   ^^^ Add C code above ^^^ ***/
}

void 
SysInputPortCB(
    Widget widget,
    XtPointer clientData,
    XtPointer callData
)
{
    /*** DTB_USER_CODE_START vvv Add C variables and code below vvv ***/
    XmToggleButtonCallbackStruct *cbs = (XmToggleButtonCallbackStruct*)callData;
    Boolean set;
    if (widget == dtb_audio_control_main_window.input_dev_rb_items.Microphone_item) {
      XtVaGetValues (widget, XmNset, &set, NULL);
      if (set == True)
        ChangeMicrophoneInputPort(SATrue);  /* Mic on */
/*
      else
        ChangeMicrophoneInputPort(SAFalse);  /* Mic off off 
*/
    }
    else if (widget == dtb_audio_control_main_window.input_dev_rb_items.Line_In_item) {
      XtVaGetValues (widget, XmNset, &set, NULL);
      if (set == True)
        ChangeLineInInputPort(SATrue); /* Line In on */
/*
      else
        ChangeLineInInputPort(SAFalse); /* Line In off 
*/
    }
    else if (widget == dtb_audio_control_main_window.input_dev_rb_items.CD_item) {
      XtVaGetValues (widget, XmNset, &set, NULL);
      if (set == True)
        ChangeCDInputPort(SATrue); /* CD on */
/*
      else
        ChangeCDInputPort(SAFalse); /* CD off 
*/
    }

    /*** DTB_USER_CODE_END   ^^^ Add C variables and code above ^^^ ***/
    
    /*** DTB_USER_CODE_START vvv Add C code below vvv ***/
    /*** DTB_USER_CODE_END   ^^^ Add C code above ^^^ ***/
}


void 
SysPlayBalanceChangeCB(
    Widget widget,
    XtPointer clientData,
    XtPointer callData
)
{
    /*** DTB_USER_CODE_START vvv Add C variables and code below vvv ***/
    double bal;
    XmScaleCallbackStruct *cbs = (XmScaleCallbackStruct*)callData;
    
    /*
     * Scale between -1, 0 1.
     * 
     * XXXX The scale values should
     * be gotten directly from the widget, not hardcoded in.
     */
    bal = ((double)cbs->value)/(100.0);
    ChangePlayBalance(bal);
    /*** DTB_USER_CODE_END   ^^^ Add C variables and code above ^^^ ***/
    
    /*** DTB_USER_CODE_START vvv Add C code below vvv ***/
    /*** DTB_USER_CODE_END   ^^^ Add C code above ^^^ ***/
}


void 
SysRecBalanceChangeCB(
    Widget widget,
    XtPointer clientData,
    XtPointer callData
)
{
    /*** DTB_USER_CODE_START vvv Add C variables and code below vvv ***/
    double bal;
    XmScaleCallbackStruct *cbs = (XmScaleCallbackStruct*)callData;
    
    /*
     * Scale between -1, 0 1.
     * 
     * XXXX The scale values should
     * be gotten directly from the widget, not hardcoded in.
     */
    bal = ((double)cbs->value)/(100.0);
    ChangeRecordBalance(bal);
    /*** DTB_USER_CODE_END   ^^^ Add C variables and code above ^^^ ***/
    
    /*** DTB_USER_CODE_START vvv Add C code below vvv ***/
    /*** DTB_USER_CODE_END   ^^^ Add C code above ^^^ ***/
}

void 
SysRecordBalCreateCB(
    Widget widget,
    XtPointer clientData,
    XtPointer callData
)
{
    DtbAudioControlMainWindowInfo	dtbSource = (DtbAudioControlMainWindowInfo)callData;
    
    /*** DTB_USER_CODE_START vvv Add C variables and code below vvv ***/
    RecordBalScale = widget;
    /*** DTB_USER_CODE_END   ^^^ Add C variables and code above ^^^ ***/
    
    /*** DTB_USER_CODE_START vvv Add C code below vvv ***/
    /*** DTB_USER_CODE_END   ^^^ Add C code above ^^^ ***/
}


void 
SysPlayVolCreateCB(
    Widget widget,
    XtPointer clientData,
    XtPointer callData
)
{
    DtbAudioControlMainWindowInfo	dtbSource = (DtbAudioControlMainWindowInfo)callData;
    
    /*** DTB_USER_CODE_START vvv Add C variables and code below vvv ***/
    PlayVolScale = widget;
    /*** DTB_USER_CODE_END   ^^^ Add C variables and code above ^^^ ***/
    
    /*** DTB_USER_CODE_START vvv Add C code below vvv ***/
    /*** DTB_USER_CODE_END   ^^^ Add C code above ^^^ ***/
}


void 
SysRecordVolCreateCB(
    Widget widget,
    XtPointer clientData,
    XtPointer callData
)
{
    DtbAudioControlMainWindowInfo	dtbSource = (DtbAudioControlMainWindowInfo)callData;
    
    /*** DTB_USER_CODE_START vvv Add C variables and code below vvv ***/
    RecordVolScale = widget;
    /*** DTB_USER_CODE_END   ^^^ Add C variables and code above ^^^ ***/
    
    /*** DTB_USER_CODE_START vvv Add C code below vvv ***/
    /*** DTB_USER_CODE_END   ^^^ Add C code above ^^^ ***/
}


void 
SysPlayBalCreateCB(
    Widget widget,
    XtPointer clientData,
    XtPointer callData
)
{
    DtbAudioControlMainWindowInfo	dtbSource = (DtbAudioControlMainWindowInfo)callData;
    
    /*** DTB_USER_CODE_START vvv Add C variables and code below vvv ***/
    PlayBalScale = widget;
    /*** DTB_USER_CODE_END   ^^^ Add C variables and code above ^^^ ***/
    
    /*** DTB_USER_CODE_START vvv Add C code below vvv ***/
    /*** DTB_USER_CODE_END   ^^^ Add C code above ^^^ ***/
}



/**************************************************************************
 *** DTB_USER_CODE_START
 ***
 *** All automatically-generated data and functions have been defined.
 ***
 *** Add new functions here, or at the top of the file.
 ***/

void
SysUpdateWidgets() {
    int scale, min, max;
    double value;
    SABoolean set;
    SAOutputFlags outputs;
    SAInputFlags  inputs;
   
    /* Set the play volume */
    XtVaGetValues(PlayVolScale, XmNminimum, &min,
				XmNmaximum, &max, NULL);
    if( GetPlayVolume(&scale, min, max)) {
	if (scale >= min && scale <= max) {
	  XtVaSetValues(PlayVolScale, XmNvalue, scale, NULL);
	  dtb_audio_control_main_window.last_play_vol = scale;
 	}
    }	

    /* Set the play balance */
    if( GetPlayBalance(&value)) {
	XtVaGetValues(PlayBalScale, XmNminimum, &min,
				    XmNmaximum, &max, NULL);
	scale = (int) (value * 100);
	if (scale >= min && scale <= max) {
	  XtVaSetValues(PlayBalScale, XmNvalue, scale, NULL);
	  dtb_audio_control_main_window.last_play_bal = scale;
	}
    }
		       
    /* Set the mute output */
    if( GetMuteOutput(&set)) {
	if (set == SATrue) {
	  XtVaSetValues(dtb_audio_control_main_window.mute_rb_items.On_item, 
			XmNset, True, NULL);
	  XtVaSetValues(dtb_audio_control_main_window.mute_rb_items.Off_item, 
			XmNset, False, NULL);
        }
	else {
	  XtVaSetValues(dtb_audio_control_main_window.mute_rb_items.On_item, 
			XmNset, False, NULL);
	  XtVaSetValues(dtb_audio_control_main_window.mute_rb_items.Off_item, 
			XmNset, True, NULL);
	}
    }

    /* Set the output ports */
    if( GetOutputPorts(&outputs)) {
	if (outputs & SADevice_Speaker) 
	  XtVaSetValues(dtb_audio_control_main_window.speaker_cbs_items.Speaker_item,
			XmNset, True, NULL);
	else
	  XtVaSetValues(dtb_audio_control_main_window.speaker_cbs_items.Speaker_item,
			XmNset, False, NULL);
  	if (outputs & SADevice_Headphone)
	  XtVaSetValues(dtb_audio_control_main_window.speaker_cbs_items.Headphone_item,
			XmNset, True, NULL);
	else
	  XtVaSetValues(dtb_audio_control_main_window.speaker_cbs_items.Headphone_item,
			XmNset, False, NULL);
	if (outputs & SADevice_LineOut)
	  XtVaSetValues(dtb_audio_control_main_window.speaker_cbs_items.Line_Out_item,
			XmNset, True, NULL);
	else
	  XtVaSetValues(dtb_audio_control_main_window.speaker_cbs_items.Line_Out_item,
			XmNset, False, NULL);
    }


    /* Set the input ports */
    if( GetInputPorts(&inputs)) {
	if (inputs & SADevice_Microphone) {
	  XtVaSetValues(dtb_audio_control_main_window.input_dev_rb_items.Microphone_item,
			XmNset, True, NULL);
	  XtVaSetValues(dtb_audio_control_main_window.input_dev_rb_items.Line_In_item,
			XmNset, False, NULL);
	  XtVaSetValues(dtb_audio_control_main_window.input_dev_rb_items.CD_item,
			XmNset, False, NULL);
	}
	else if (inputs & SADevice_LineIn) {
	  XtVaSetValues(dtb_audio_control_main_window.input_dev_rb_items.Microphone_item,
			XmNset, False, NULL);
	  XtVaSetValues(dtb_audio_control_main_window.input_dev_rb_items.Line_In_item,
			XmNset, True, NULL);
	  XtVaSetValues(dtb_audio_control_main_window.input_dev_rb_items.CD_item,
			XmNset, False, NULL);
	}
	else if (inputs & SADevice_CD) {
	  XtVaSetValues(dtb_audio_control_main_window.input_dev_rb_items.Microphone_item,
			XmNset, False, NULL);
	  XtVaSetValues(dtb_audio_control_main_window.input_dev_rb_items.Line_In_item,
			XmNset, False, NULL);
	  XtVaSetValues(dtb_audio_control_main_window.input_dev_rb_items.CD_item,
			XmNset, True, NULL);
	}
	else { /* No inputs selected */
	  XtVaSetValues(dtb_audio_control_main_window.input_dev_rb_items.Microphone_item,
			XmNset, False, NULL);
	  XtVaSetValues(dtb_audio_control_main_window.input_dev_rb_items.Line_In_item,
			XmNset, False, NULL);
	  XtVaSetValues(dtb_audio_control_main_window.input_dev_rb_items.CD_item,
			XmNset, False, NULL);
	}
    }

    /* Set the record volume */
    XtVaGetValues(RecordVolScale, XmNminimum, &min,
				  XmNmaximum, &max, NULL);
    if( GetRecordVolume(&scale, min, max)) {
	if (scale >= min && scale <= max) {
	  XmScaleSetValue(RecordVolScale, scale);
	  dtb_audio_control_main_window.last_record_vol = scale;
	}
    }

    /* Set the record balance */
    if( GetRecordBalance(&value)) {
	XtVaGetValues(RecordBalScale, XmNminimum, &min,
				      XmNmaximum, &max, NULL);
	scale = (int) (value * 100);
	if (scale >= min && scale <= max) {
	  XtVaSetValues(RecordBalScale, XmNvalue, scale, NULL);
	  dtb_audio_control_main_window.last_record_bal = scale;
	}
    }

    /* Update the display  */
     XFlush(XtDisplay(PlayVolScale));
}

void SysSetSigPollHandler() {

    struct sigaction action;
    action.sa_handler = SysUpdateWidgets;
    sigemptyset(&action.sa_mask);
    action.sa_flags = 0;
    if( sigaction(SIGPOLL, &action, NULL) < 0) {
	perror("Couldn't set sigpoll handler");
	exit(-1);
    }

}

/*** DTB_USER_CODE_END
 ***
 *** End of user code section
 ***
 **************************************************************************/


